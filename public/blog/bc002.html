<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Async Shipping Quotes via Page Background Tasks</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@2.5.0/fonts/remixicon.css" rel="stylesheet">
    <link href="/blogAsset/style.css" rel="stylesheet">
    <link href="/blogAsset/script.js" rel="Script">
</head>
<body>
<div class="container">
    <header>
        <h1>Handling Slow API Calls with Page Background Tasks</h1>
    </header>

    <section>
        <h2><i class="ri-building-2-line"></i> Background</h2>
        <p>My company manufactures furniture and sells directly to customers. Given the vast geography of the USA, we partner with third-party shipping agents (FedEx, UPS, etc.) for logistics, operating out of three warehouses across the country.</p>
        
        <div class="highlight-box">
            <strong><i class="ri-alert-line"></i> The Problem</strong>
            When the Sales Team creates a Sales Order, they need to quickly check shipping costs via carrier APIs. Because these API calls can be slow and we check multiple agents simultaneously and <b>traditional foreground calls were freezing the UI</b>, leading to long wait times and user frustration.
        </div>
    </section>

    <section>
        <h2><i class="ri-lightbulb-line"></i> Solution</h2>
        <p>I implemented <strong>Page Background Tasks</strong> to solve this. I added fields on the Sales Order page to display quote prices for each shipping agent and created an Action to trigger the API calls asynchronously. The prices update automatically once the data is received from the third-party service without blocking the user.</p>
    </section>

    <section>
        <h2><i class="ri-code-s-slash-line"></i> Technical Implementation</h2>
        <div class="tags-container">
            <span class="tag"><i class="ri-hashtag"></i>CurrPage.EnqueueBackgroundTask</span>
            <span class="tag"><i class="ri-hashtag"></i>OnPageBackgroundTaskCompleted</span>
            <span class="tag"><i class="ri-hashtag"></i>OnPageBackgroundTaskError</span>
        </div>

        <h3>Step 1: Add "Quote Price" fields</h3>
        <p>I used Page Variables for this purpose since these values do not need to be stored in the database.</p>
        <div class="code-wrapper">
            <div class="code-header">
                <div class="dot red"></div><div class="dot yellow"></div><div class="dot green"></div>
                <div class="code-title">PageExtension.al</div>
            </div>
<pre><code>pageextension 70002 "ALE Sales Order PageExt" extends "Sales Order"
{
    layout
    {
        addlast(General)
        {
            group(ALEShippingQuotes)
            {
                Editable = false;
                Caption = 'Shipping Quotes';

                field("ALE Fedex Quote"; gFedexQuote)
                {
                    Caption = 'Fedex Quote';
                    ApplicationArea = All;
                    StyleExpr = gFeDexStyleExpr;
                    ToolTip = 'Specifies the value of the Fedex Quote field.';
                }
                field("ALE UPS Quote"; gUPSQuote)
                {
                    Caption = 'UPS Quote';
                    ApplicationArea = All;
                    StyleExpr = gUPSStyleExpr;
                    ToolTip = 'Specifies the value of the UPS Quote field.';
                }
                // ... (Fields for Purolator, SpeeDee, Dicom omitted for brevity)
            }
        }
    }
    var
        gFedexQuote: Decimal;
        gUPSQuote: Decimal;
        // ... (Variables for other carriers)

        gFeDexStyleExpr: Text;
        gUPSStyleExpr: Text;
        // ... (Style variables for other carriers)
}</code></pre>
        </div>

        <h3>Step 2: Create a Codeunit to handle API Logic</h3>
        <p>Since this runs as a background task, I added logic to retrieve parameters passed from the page.</p>
        <div class="code-wrapper">
            <div class="code-header">
                <div class="dot red"></div><div class="dot yellow"></div><div class="dot green"></div>
                <div class="code-title">Codeunit.al</div>
            </div>
<pre><code>codeunit 70000 "ALE Get Web Order Status"
{
    trigger OnRun()
    var
        Inputs: Dictionary of [Text, Text];
        Results: Dictionary of [Text, Text];
        SalesOrderNo: Text;
        ShippingVendorNo: Text;
    begin
        Inputs := Page.GetBackgroundParameters();

        SalesOrderNo := Inputs.Get('NO');
        ShippingVendorNo := Inputs.Get('VENDOR');

        Results.Add('Price', CallAPIGetShippingCost(SalesOrderNo, ShippingVendorNo));

        Page.SetBackgroundTaskResult(Results);
    end;

    local procedure CallAPIGetShippingCost(pNo: Text; ShippingVendorNo: Text): Text
    begin
        // Call API - Logic simulated with sleep/random for demo
        Sleep(Random(10000));
        exit(Format(Random(1000)));
    end;
}</code></pre>
        </div>

        <h3>Step 3: Add Action to trigger the process</h3>
        <p>I used the system function <code>EnqueueBackgroundTask</code> to execute the Codeunit asynchronously.</p>
        <div class="code-wrapper">
            <div class="code-header">
                <div class="dot red"></div><div class="dot yellow"></div><div class="dot green"></div>
                <div class="code-title">Action.al</div>
            </div>
<pre><code>addlast(processing)
{
    action(ALEGetQuote)
    {
        Image = Questionaire;
        ApplicationArea = All;
        Caption = 'Get Shipment Quote';
        trigger OnAction()
        var
            TimeoutinMs: Integer;
        begin
            TimeoutinMs := 10000;
            GetShippingQuote('Fedex', TimeoutinMs, gFedexQuoteTaskID);
            GetShippingQuote('UPS', TimeoutinMs, gUPSQuoteTaskID);
            // ... Call for other carriers
        end;
    }
}

local procedure GetShippingQuote(VendorNo: Text; TimeoutinMs: Integer; var TaskID: Integer)
var
    Input: Dictionary of [Text, Text];
begin
    Input.Add('NO', Rec."No.");
    Input.Add('VENDOR', VendorNo);
    CurrPage.EnqueueBackgroundTask(TaskID, Codeunit::"ALE Get Web Order Status", Input, TimeoutinMs);
end;</code></pre>
        </div>

        <h3>Step 4: Handle Completion (UI Update)</h3>
        <p>The <code>OnPageBackgroundTaskCompleted</code> trigger retrieves results. Successful quotes are highlighted in green.</p>
        <div class="code-wrapper">
            <div class="code-header">
                <div class="dot red"></div><div class="dot yellow"></div><div class="dot green"></div>
                <div class="code-title">Trigger_Completed.al</div>
            </div>
<pre><code>trigger OnPageBackgroundTaskCompleted(TaskId: Integer; Results: Dictionary of [Text, Text])
begin
    if TaskId = gFedexQuoteTaskID then begin
        Evaluate(gFedexQuote, Results.Get('Price'));
        gFeDexStyleExpr := 'Favorable'; // Green + Bold
    end;
    if TaskId = gUPSQuoteTaskID then begin
        Evaluate(gUPSQuote, Results.Get('Price'));
        gUPSStyleExpr := 'Favorable';
    end;
    // ... Repeat for other carriers
end;</code></pre>
        </div>

        <h3>Step 5: Handle Errors</h3>
        <p>The <code>OnPageBackgroundTaskError</code> trigger handles failures (e.g., timeout). Failed quotes display as 0 and are highlighted in red.</p>
        <div class="code-wrapper">
            <div class="code-header">
                <div class="dot red"></div><div class="dot yellow"></div><div class="dot green"></div>
                <div class="code-title">Trigger_Error.al</div>
            </div>
<pre><code>trigger OnPageBackgroundTaskError(TaskId: Integer; ErrorCode: Text; ErrorText: Text; ErrorCallStack: Text; var IsHandled: Boolean)
begin
    if TaskId = gFedexQuoteTaskID then begin
        IsHandled := true;
        gFedexQuote := 0;
        gFeDexStyleExpr := 'Unfavorable'; // Red + Bold
    end;
    // ... Repeat for other carriers
end;</code></pre>
        </div>
    </section>

    <section>
        <h2><i class="ri-thumb-up-line"></i> Pros</h2>
        <ul class="pro-list">
            <li><i class="ri-check-line"></i> <strong>Zero UI Blocking:</strong> Users can continue working in BC while the system calls the API.</li>
            <li><i class="ri-check-line"></i> <strong>Parallel Processing:</strong> Minimizes wait time compared to sequential foreground calls.</li>
            <li><i class="ri-check-line"></i> <strong>Minimize Customization:</strong> Clean implementation using standard platform capabilities.</li>
        </ul>
    </section>

    <section>
        <h2><i class="ri-movie-line"></i> Test</h2>
        
        <iframe width="90%" height="700px" src="https://www.youtube.com/embed/OnGw5xTV6wM?si=7cHWo5eUaDGdWAPz" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
    </section>

</div>


</body>
</html>