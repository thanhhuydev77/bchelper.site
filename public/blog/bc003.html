<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BC-SOLUTIONS-003: Print Sales Order Attachment by Batch</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@2.5.0/fonts/remixicon.css" rel="stylesheet">
    <link href="/blogAsset/style.css" rel="stylesheet">
    <link href="/blogAsset/script.js" rel="Script">
</head>
<body>
<div class="container">
    <header>
        <h1></i>Print Sales Order Attachment by Batch</h1>
    </header>

    <section>
        <h2><i class="ri-building-2-line"></i> Background</h2>
        <p>Our Sales Team attaches the Customer's Purchase Order (PDF) to each corresponding Sales Order in Business Central. When the Warehouse Team ships the order, they need to print this attachment to stick it onto the package.</p>
        <p>We are using <strong>Business Central OnCloud</strong> and have Universal Print configured.</p>
        
        <div class="highlight-box">
            <strong><i class="ri-alert-line"></i> The Problem</strong>
            Currently, the Warehouse Team has to download individual PDF files and print them one by one using the Windows print dialog. This manual process is time-consuming and inefficient. Business Central allows downloading files but does not natively support direct printing of attachments like it does for standard reports.
        </div>
    </section>

    <section>
        <h2><i class="ri-checkbox-circle-line"></i> Requirement</h2>
        <p>The Warehouse Team needs a function within Business Central to:</p>
        <ul>
            <li>Print PDF attachments directly without downloading.</li>
            <li>Batch print attachments for multiple Sales Orders simultaneously.</li>
            <li>Select a specific printer from the Business Central printer list.</li>
        </ul>
    </section>

    <section>
        <h2><i class="ri-lightbulb-line"></i> Solution Overview</h2>
        <p>We will create a new Report object to act as a wrapper for the printing process. By subscribing to the <code>OnAfterDocumentReady</code> event, we can intercept the report generation and replace the empty report content with the actual PDF stream from the attachment before sending it to the printer.</p>
        
    </section>

    <section>
        <h2><i class="ri-code-s-slash-line"></i> Technical Implementation</h2>
        <div class="tags-container">
            <span class="tag"><i class="ri-hashtag"></i> Report.Print</span>
            <span class="tag"><i class="ri-hashtag"></i> OnAfterDocumentReady</span>
            <span class="tag"><i class="ri-hashtag"></i> RecRef</span>
        </div>

        <h3>Step 1: Create a "Dummy" Report</h3>
        <p>This report simulates the printing action. We use <code>Document Attachment</code> as the dataset. The layout design is irrelevant because the content will be replaced by the PDF file later.</p>
        <div class="code-wrapper">
            <div class="code-header">
                <div class="dot red"></div><div class="dot yellow"></div><div class="dot green"></div>
                <div class="code-title">Report_Dummy.al</div>
            </div>
<pre><code>namespace BC003;

using Microsoft.Foundation.Attachment;

Report 70000 "ALE Print PDF File"
{
    Caption = 'ATL Print PDF File';
    UsageCategory = None; // Not Searchable
    ApplicationArea = All;
    PreviewMode = PrintLayout;
    DefaultRenderingLayout = LayoutName;

    dataset
    {
        dataitem("Document Attachment"; "Document Attachment")
        {
            RequestFilterFields = ID;
            column(ID; ID) { } // Keep to avoid empty dataset error
        }
    }

    rendering
    {
        layout(LayoutName)
        {
            Type = RDLC;
            LayoutFile = '.\Layout\EmptyLayout.rdlc';
        }
    }
}</code></pre>
        </div>

        <h3>Step 2: Create a Report to Select Printer</h3>
        <p>This processing-only report iterates through selected Sales Orders, finds the relevant attachments, and triggers the print command.</p>
        <div class="code-wrapper">
            <div class="code-header">
                <div class="dot red"></div><div class="dot yellow"></div><div class="dot green"></div>
                <div class="code-title">Report_Processor.al</div>
            </div>
<pre><code>namespace BC003;

using Microsoft.Foundation.Attachment;
using System.Device;
using Microsoft.Sales.Document;

report 70001 "ALE Print SO Attachment"
{
    Caption = 'Print SO Attachment';
    UsageCategory = Tasks;
    ApplicationArea = All;
    ProcessingOnly = true;
    dataset
    {
        dataitem("Sales Header"; "Sales Header")
        {
            RequestFilterFields = "Document Type", "No.";

            dataitem(DocumentAttachment; "Document Attachment")
            {
                DataItemLink = "No." = field("No."), "Document Type" = field("Document Type");
                DataItemTableView = where("Table ID" = const(Database::"Sales Header"));
                RequestFilterFields = ID;

                trigger OnAfterGetRecord()
                begin
                    ProcessPrint(DocumentAttachment.ID);
                end;
            }
        }
    }
    requestpage
    {
        layout
        {
            area(Content)
            {
                field("Printer Name"; gPrinterName)
                {
                    Caption = 'Printer Name';
                    ApplicationArea = All;
                    TableRelation = Printer.ID;
                }
            }
        }
    }

    local procedure ProcessPrint(pID: Integer)
    var
        DocumentAttachment: Record "Document Attachment";
        RecRef: RecordRef;
    begin
        RecRef.Open(Database::"Document Attachment");
        DocumentAttachment.SetRange(ID, pID);
        RecRef.SetView(DocumentAttachment.GetView());
        
        // This triggers the dummy report, but sends it to the specific printer
        Report.Print(Report::"ALE Print PDF File", '', gPrinterName, RecRef);

        RecRef.Close();
    end;

    var
        gPrinterName: Text;
}</code></pre>
        </div>

        <h3>Step 3: Subscribe to OnAfterDocumentReady</h3>
        <p>This is the critical step. We intercept the stream sent to the printer and replace it with the PDF content from the attachment.</p>
        
        <div class="code-wrapper">
            <div class="code-header">
                <div class="dot red"></div><div class="dot yellow"></div><div class="dot green"></div>
                <div class="code-title">Codeunit_EventSub.al</div>
            </div>
<pre><code>namespace BC003;

using Microsoft.Foundation.Attachment;
using Microsoft.Foundation.Reporting;

codeunit 70001 "ALE Report Events Subs"
{
    [EventSubscriber(ObjectType::Codeunit, Codeunit::ReportManagement, OnAfterDocumentReady, '', false, false)]
    local procedure ReportManagement_OnAfterDocumentReady(ObjectId: Integer; ObjectPayload: JsonObject; DocumentStream: InStream; var TargetStream: OutStream; var Success: Boolean)
    begin
        case ObjectId of
            Report::"ALE Print PDF File":
                HandleReplaceReportContent(ObjectPayload, TargetStream, Success);
        end;
    end;

    procedure HandleReplaceReportContent(ObjectPayload: JsonObject; var TargetStream: OutStream; var Success: Boolean)
    var
        DocumentAttachment: Record "Document Attachment";
    begin
        // Extract filter from payload to find the correct record
        DocumentAttachment.SetView(GetAttachmentFileViewFromPayload(ObjectPayload));
        DocumentAttachment.FindLast();
        
        // Export the PDF blob directly to the target printer stream
        DocumentAttachment.ExportToStream(TargetStream);
        Success := true;
    end;

    local procedure GetAttachmentFileViewFromPayload(ObjectPayload: JsonObject): Text
    var
        FilterViews: JsonToken;
        FilterView: JsonToken;
        View: JsonToken;
    begin
        ObjectPayload.Get('filterviews', FilterViews);
        FilterViews.AsArray().Get(0, FilterView);
        FilterView.AsObject().Get('view', View);
        exit(View.AsValue().AsText());
    end;
}</code></pre>
        </div>

        <h3>Step 4: Add Action to Sales Order List</h3>
        <p>Enable the user to select multiple orders and run the print job.</p>
        <div class="code-wrapper">
            <div class="code-header">
                <div class="dot red"></div><div class="dot yellow"></div><div class="dot green"></div>
                <div class="code-title">PageExtension.al</div>
            </div>
<pre><code>namespace BC003;

using Microsoft.Foundation.Attachment;
using Microsoft.Sales.Document;

pageextension 70004 "ALE Sales Order List 2" extends "Sales Order List"
{
    actions
    {
        addfirst(processing)
        {
            action(ALEPrint)
            {
                Image = PrintCheck;
                Caption = 'Print Attachments';
                ApplicationArea = all;
                ToolTip = 'Print PDF attachments for the selected Sales Orders.';
                
                trigger OnAction()
                var
                    SalesHeader: Record "Sales Header";
                    PrintPDFFile: Report "ALE Print SO Attachment";
                begin
                    CurrPage.SetSelectionFilter(SalesHeader);

                    if not SalesHeader.IsEmpty() then begin
                        PrintPDFFile.SetTableView(SalesHeader);
                        PrintPDFFile.Run();
                    end;
                end;
            }
        }
    }
}</code></pre>
        </div>
    </section>

    <section>
        <h2><i class="ri-thumb-up-line"></i> Pros</h2>
        <ul class="pro-list">
            <li><i class="ri-time-line"></i> <strong>Time Saving:</strong> Eliminates manual download and print steps.</li>
            <li><i class="ri-printer-line"></i> <strong>Printer Selection:</strong> Allows utilizing any printer connected to Business Central.</li>
            <li><i class="ri-tools-line"></i> <strong>Simple Customization:</strong> Uses standard event subscribers with minimal overhead.</li>
        </ul>
    </section>

    <section>
        <h2><i class="ri-movie-line"></i> Test Plan</h2>
       <iframe width="90%" height="700px" src="https://www.youtube.com/embed/EGrMEnMdNR0?si=cte4bM3SmgHpTr16" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
    </section>

</div>
</body>
</html>